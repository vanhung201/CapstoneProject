@model IEnumerable<BusinessConnectManagement.Models.YearStudy>

@{
    ViewBag.Title = "Index";
    Layout = "~/Areas/Admin/Views/Shared/_Layout.cshtml";
}

<section class="list">

    <h1 class="list-heading">DANH SÁCH NĂM HỌC</h1>
    @if (TempData != null)
    {
        @Html.Raw(@TempData["AlertMessage"])
    }
    <div class="list-table">
        <div id="filterEvent">
            <a>
                <div class="btn btn--create" style="margin-right:10px; z-index:1;">
                    <span class="btn-text">Thêm</span>
                </div>
            </a>
        </div>
        <table id="table_listData" class="display" width="100%">

            <thead>
                <tr>
                    <th>STT</th>
                    <th>Năm Học</th>
                    <th>Học Kỳ</th>
                    <th width="30%">Chức Năng</th>
                </tr>
            </thead>
            <tbody>
            </tbody>
        </table>
    </div>
</section>
@*-------------------addyear-----------------------------------*@
<form action="@Url.Action("Create", "YearStudies")" class="form" id="addForm" method="post">
    <div class="form-container--small">
        <h1 class="form-heading">Thêm Năm Học</h1>
        <div class="form-group">
            <label for="cooperationName" class="form-label">Năm Học</label>
            <input name="YearStudy1" type="text" class="form-input" id="checkspace2" required>
        </div>
        <div class="form-group">
            <label for="cooperationName" class="form-label">Ngày Bắt Đầu</label>
            <input name="StartDate" id="StartDate1" type="date" onchange="checkDate()" class="form-input">
        </div>
        <div class="form-group">
            <label for="cooperationName" class="form-label">Ngày Kết Thúc</label>
            <input name="EndDate" id="EndDate1" type="date" onchange="checkDate()" class="form-input">
        </div>
        <div class="form-group">
            <a class="btn btn--cancel">Hủy</a>
            <button type="submit" class="btn btn--confirm">Xác Nhận</button>
        </div>
    </div>
</form>

@*---------------modifyyearnow--------------*@
<form action="@Url.Action("Update", "YearStudies")" class="form" id="confirmForm" method="post">
    <div class="form-container--small">
        <h1 class="form-heading">Điều Chỉnh Năm Học Hiện Tại</h1>
        <div class="form-group">
            <input name="ID" id="id" hidden />
            <input name="YearStudy1" class="form-input" id="name" hidden />
            <input name="Status" value="true" hidden />
            <input name="StartDate" id="startdate" hidden />
            <input name="EndDate"  id="enddate"  hidden/>
            <span>
                Bạn chắc chắn muốn đặt<strong name="name" style="font-weight: bold; color: #ce1b28;"> Học Kỳ </strong><strong name="name" id="namedele" style="font-weight: bold; color: #ce1b28;"></strong>
                là năm học hiện tại không?
            </span>
        </div>
        <div class="form-group">
            <a class="btn btn--cancel">Hủy</a>
            <button class="btn btn--confirm" id="btn--update" type="submit">
                Xác Nhận
            </button>
        </div>
    </div>
</form>


@*---------------------------semester------------------------*@
@*--------------------------update---------------------*@
<form class="form" id="updateForm" method="post">
    <div class="form-container--small">
        <h1 class="form-heading">Cập Nhật Năm Học</h1>
        <div class="form-group">
            <label for="cooperationName" class="form-label">Năm Học</label>
            <input name="ID" id="ID" hidden />
            <input name="Status" id="Status" hidden />
            <input type="text" name="YearStudy1" class="form-input" id="YearStudy" required>
        </div>
        <div class="form-group">
            <label for="cooperationName" class="form-label">Ngày Bắt Đầu</label>
            <input name="StartDate" id="StartDate" type="date" onchange="checkDate()" class="form-input">
        </div>
        <div class="form-group">
            <label for="cooperationName" class="form-label">Ngày Kết Thúc</label>
            <input name="EndDate" id="EndDate" type="date" onchange="checkDate()" class="form-input">
        </div>
        <div class="form-group">
            <a class="btn btn--cancel">Hủy</a>
            <button class="btn btn--confirm" id="btn--update" type="submit">
                Xác Nhận
            </button>
        </div>
    </div>
</form>


@*-------------delete------------*@

@section Scripts {
    <script type="text/javascript">

        function loadEdit(id, name, startdate, enddate) {
            let formUpdate = document.getElementById("confirmForm");
            formUpdate.classList.add('is-appear')
            document.getElementById('name').value = name;
            document.getElementById('id').value = id;
            document.getElementById('startdate').value = startdate;
            document.getElementById('enddate').value = enddate;
            $('#namedele').text(name)

        }

        $('#btn--update').on('click', function () {
            $('#updateForm').submit()
        })
        $('.btn--cancel').on('click', function () {
            $('#addForm').removeClass('is-appear')
            $('#confirmForm').removeClass('is-appear')
        })
         $(function () {
        var url = "@Url.Action("getDataList", "YearStudies")"
        "use strict";
             (dataTable = $("#table_listData").DataTable({
            ajax: {
                url: url,
                type: "GET",
                dataType: "json",
                dataSrc: "",
            },
                 deferRender: !0,
                 "order": [[1, "desc"]],
                 "columnDefs": [
                     { "width": "10%", "target": 2 }
                 ],
                columns: [
                    { data: null },
                    { data: "name" },
                    {
                            data: "id",
                            render: function (t, e, a) {
                                return (
                                    `
                                    <a href="@Url.Action("Details", "YearStudies")/${t}" id="business_detail" class="business_detail">
                                    <div class="btn btn--detail" title="Cập Nhật">
                                        <i class="btn-icon btn-icon--detail fal fa-info-circle"></i>
                                    </div>
                                    </a>
                                   `
                                );
                            },
                    },
                    {
                            data: "id",
                        render: function (t, e, a) {
                            var dateString = `${a.startDate}`;
                            var timestamp = parseInt(dateString.replace(/[^0-9]/g, ""));
                            var date = new Date(timestamp);
                            var startdate = convertDate(a.startDate)
                            var enddate = convertDate(a.endDate)
                            var timeZone = "Asia/Ho_Chi_Minh";

                            // Options for formatting the date and time
                            var options = {
                                timeZone: timeZone,
                                year: 'numeric',
                                month: '2-digit',
                                day: '2-digit',
                                hour: '2-digit',
                                minute: '2-digit',
                                second: '2-digit'
                            };
                            var formattedEndDate = date.toLocaleString('en-US', options);
                            var now = new Date(); // Current date and time
                            var formattedNow = now.toLocaleString('en-US', options);
                            const sttBtn = (a.status == true) ? ` <a href="#" style="margin-left: 10px">
                                    <div class="btn btn--confirm" style=" width: 200px">
                                        Năm Học Hiện Tại
                                    </div>
                                </a>` : (formattedEndDate > formattedNow) ?
                                `
                                <a onclick="loadEdit('${a.id}','${a.name}','${startdate}','${enddate}' )" style="margin-left: 10px">
                                    <div class="btn btn--update" style=" width: 300px; position: absolute;">
                                        Đặt Làm Năm Học Hiện Tại
                                    </div>
                                </a>
                                ` : "";
                                return (
                                    `
                                    <a href="@Url.Action("Edit", "YearStudies")/${t}" class="business_update">
                                        <div class="btn btn--update" title="Cập Nhật">
                                            <i class="btn-icon btn-icon--edit fal fa-edit"></i>
                                        </div>
                                    </a>
                                    ${sttBtn}
                                    `
                                );
                            },
                    },
                ],
        }))
        dataTable.on("draw.dt", function () {
            dataTable.column(0, { search: "applied", order: "applied" }).nodes().each(function (cell, i) {
                cell.innerHTML = i + 1;
            });
        });
        // Create Index column datatable


         });


        function convertDate(dateString) {
            const timestamp = parseInt(dateString.match(/\d+/)[0]);
            const date = new Date(timestamp);
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const formattedDate = `${year}-${month}-${day}`;
            return formattedDate;
        }
        /*---------------------------update------------------------*/
        $('#table_listData').on('click', '.business_update', function (e) {
            e.preventDefault()
            const form = document.getElementById('updateForm');
            form.classList.add('is-appear');
            const url = $(this).attr('href');
            $.ajax({
                url: url,
                type: "get",
                dataType: 'json',
                success: function (res) {
                    console.log(res);
                    const actionUrl = `@Url.Action("Edit", "YearStudies")` + `/${res[0].id}`
                    $('#ID').val(res[0].id)
                    $('#YearStudy').val(res[0].name)
                    $('#updateForm').attr('action', `${actionUrl}`)
                    $('#StartDate').val(res[0].startDate);
                    $('#EndDate').val(res[0].endDate);
                    $('#Status').val(res[0].status);
                    
                }

            })
        })
        function extractDate(dateString) {
            var timeZone = "Asia/Ho_Chi_Minh";
            // Options for formatting the date and time
            var options = {
                timeZone: timeZone,
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            };
            var timestamp = parseInt(dateString.replace(/[^0-9]/g, ""));
            return new Date(timestamp).toLocaleString('en-US', options);
        }
        /*---------------delete------------*/
        function loadDeleteUser(id) {
            let formDelete = document.getElementById("deleteForm");
            formDelete.classList.add('is-appear')
            document.getElementById('iddele').value = id;
        }
/*------------------close-form-----------------------*/
        $('#form_detail .btn--cancel').on('click', function () {
            $('#form_detail').removeClass('is-appear')
        })

        $('#form_detail .btn--create').on('click', function () {
            $('#addFormCr').addClass('is-appear')
        })
        $('.btn--cancel').on('click', function () {
            $('#updateForm').removeClass('is-appear')
        })

        $('#addFormCr .btn--cancel').on('click', function () {
            $('#addFormCr').removeClass('is-appear')
        })

        function reLoad() {
            window.location.reload();
        }

    </script>
    <script>
        $(document).ready(function () {
            $.validator.addMethod("blank", function (value, element) {
                return (!/^\s*$/.test(value));
            }, "Vui lòng nhập năm học.");

            // Initialize the form validation
            $("#addForm").validate();

            // cái này là on blur nè
            $("#addForm input, #addForm input").on("blur", function () {
                $(this).valid();
            });

            // cái này là on change nè
            $("#addForm input, #addForm input").on("change", function () {
                $(this).removeClass("error");
            });

            /*--------------------------update---------------*/
            $("#updateForm").validate();
            // cái này là on blur nè
            $("#updateForm input, #updateForm input").on("blur", function () {
                $(this).valid();
            });

            // cái này là on change nè
            $("#updateForm input, #updateForm input").on("change", function () {
                $(this).removeClass("error");
            });
        });
        $("#addForm").validate({
            rules: {
                YearStudy1: {
                    required: true,
                    blank: true
                }
            },
            messages: {
                YearStudy1: {
                    required: "Vui lòng nhập năm học"
                }
            }
        });
        $("#updateForm").validate({
            rules: {
                YearStudy1: {
                    required: true,
                    blank: true
                }
            },
            messages: {
                YearStudy1: {
                    required: "Vui lòng nhập năm học"
                }
            }
        });

        function checkDate() {
            var dateInputs = document.querySelectorAll('input[type="date"]');
            var now = Date.now();

            for (var i = 0; i < dateInputs.length; i++) {
                var selectedText = dateInputs[i].value;
                var selectedDate = new Date(selectedText);

                if (selectedDate <= now) {
                    dateInputs[i].value = "dd/mm/yyyy";
                    alert("Vui lòng không chọn những ngày trước.");
                    return false;
                }
            }

            return true;
        }

    </script>
}